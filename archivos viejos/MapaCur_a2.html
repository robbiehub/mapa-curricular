<!DOCTYPE html>
<html>
  <head>
      <title>Calando D3</title>
      <script type="text/javascript" src="d3.v2.js"></script>
      <script type="text/javascript" src="obtenerDatos.js"></script>

      <LINK REL=StyleSheet HREF="overlay.css" TYPE="text/css" MEDIA=screen>
  </head>

  <style>
    .link {
      stroke: #000;
      stroke-width: 1.5px;
    }
  </style>

  <body>
      <h1 class="header">Mapa Curricular</h1>
      <div id="viz" class="divi"></div>
      <script type="text/javascript">

      var datos = LeerExcel();
  /*    var datos = {
        materias: [{nombre: "Calculo Diferencial e Integral I",
                        x: 50,
                        y: 50,
                        creditos: 8,
                        mat_requiere: [null],
                        mat_abre: [2], tipo: 1, semestre: 1},

                    {nombre: "Geometria",
                          x: 50,
                          y: 150,
                          creditos: 6,
                          mat_requiere: [null],
                          mat_abre: [3], tipo: 1, semestre: 1},

                    {nombre: "Algebra",
                          x: 50,
                          y: 250,
                          creditos: 6,
                          mat_requiere: [0],
                          mat_abre: [null], tipo: 1, semestre: 1},

                    {nombre: "Intro",
                          x: 50,
                          y: 350,
                          creditos: 6,
                          mat_requiere: [1],
                          mat_abre: [null], tipo: 2, semestre: 1},

                    {nombre: "Algebra-2",
                          x: 50,
                          y: 450,
                          creditos: 6,
                          mat_requiere: [0],
                          mat_abre: [null], tipo: 1, semestre: 1},

                    {nombre: "Algebra-3",
                          x: 250,
                          y: 50,
                          creditos: 6,
                          mat_requiere: [0],
                          mat_abre: [null], tipo: 1, semestre: 2},

                    {nombre: "Algebra-4",
                          x: 250,
                          y: 150,
                          creditos: 6,
                          mat_requiere: [0],
                          mat_abre: [null], tipo: 1, semestre: 2},

                    {nombre: "Algebra-5",
                          x: 250,
                          y: 250,
                          creditos: 6,
                          mat_requiere: [0],
                          mat_abre: [null], tipo: 1, semestre: 2},

                    {nombre: "Algebra-6",
                          x: 250,
                          y: 350,
                          creditos: 6,
                          mat_requiere: [0],
                          mat_abre: [null], tipo: 1, semestre: 2},

                    {nombre: "Algebra-7",
                          x: 250,
                          y: 450,
                          creditos: 6,
                          mat_requiere: [0],
                          mat_abre: [null], tipo: 1, semestre: 2},

                    {nombre: "Algebra-8",
                          x: 450,
                          y: 50,
                          creditos: 6,
                          mat_requiere: [0],
                          mat_abre: [null], tipo: 1, semestre: 3},

                    {nombre: "Algebra-9",
                          x: 450,
                          y: 150,
                          creditos: 6,
                          mat_requiere: [0],
                          mat_abre: [null], tipo: 1, semestre: 3},

                    {nombre: "Algebra-10",
                          x: 450,
                          y: 250,
                          creditos: 6,
                          mat_requiere: [0],
                          mat_abre: [null], tipo: 1, semestre: 3},

                    {nombre: "Algebra-11",
                          x: 450,
                          y: 350,
                          creditos: 6,
                          mat_requiere: [0],
                          mat_abre: [null], tipo: 1, semestre: 3},

                    {nombre: "Algebra-12",
                          x: 450,
                          y: 450,
                          creditos: 6,
                          mat_requiere: [0],
                          mat_abre: [null], tipo: 1, semestre: 3},

                    {nombre: "Algebra-13",
                          x: 650,
                          y: 50,
                          creditos: 6,
                          mat_requiere: [0],
                          mat_abre: [null], tipo: 1, semestre: 4},

                    {nombre: "Algebra-14",
                          x: 650,
                          y: 150,
                          creditos: 6,
                          mat_requiere: [0],
                          mat_abre: [null], tipo: 1, semestre: 4},

                    {nombre: "Algebra-15",
                          x: 650,
                          y: 250,
                          creditos: 6,
                          mat_requiere: [0],
                          mat_abre: [null], tipo: 1, semestre: 4},

                    {nombre: "Algebra-16",
                          x: 650,
                          y: 350,
                          creditos: 6,
                          mat_requiere: [0],
                          mat_abre: [null], tipo: 1, semestre: 4},

                    {nombre: "Algebra-17",
                          x: 650,
                          y: 450,
                          creditos: 6,
                          mat_requiere: [0],
                          mat_abre: [null], tipo: 1, semestre: 4},

                    {nombre: "Algebra-18",
                          x: 850,
                          y: 50,
                          creditos: 6,
                          mat_requiere: [0],
                          mat_abre: [null], tipo: 3, semestre: 5},

                    {nombre: "Algebra-19",
                          x: 850,
                          y: 150,
                          creditos: 6,
                          mat_requiere: [0],
                          mat_abre: [null], tipo: 3, semestre: 5},

                    {nombre: "Algebra-20",
                          x: 850,
                          y: 250,
                          creditos: 6,
                          mat_requiere: [0],
                          mat_abre: [null], tipo: 3, semestre: 5},

                    {nombre: "Algebra-21",
                          x: 850,
                          y: 350,
                          creditos: 6,
                          mat_requiere: [0],
                          mat_abre: [null], tipo: 4, semestre: 5},

                    {nombre: "Algebra-22",
                          x: 850,
                          y: 450,
                          creditos: 6,
                          mat_requiere: [0],
                          mat_abre: [null], tipo: 4, semestre: 5},
            ]
      };
*/
      //Aqui estoy creando el canvas
      var sampleSVG = d3.select("#viz")
          .append("svg")
          .attr("id", "canvas")
          .attr("width", "1280")//1200)
          .attr("height", "720")
          //.attr("class", "sca")
          //.attr("viewbox", "0 0 60 55");

      var j=-1, ren = 0;

      var links = sampleSVG.selectAll(".link");

      //Aqui estoy creando un grupo llamado rectangulos
      var rectangulos = sampleSVG.selectAll("g")
                              .data(datos.materias) //Aqui le digo que utilize los datos que estan en la variable datos
                            .enter().append("g")
                              //.attr("transform", "translate(\"25%\",0)")
                                //.attr("x", "25%")
                            /*    .attr("transform", function(d){
                                  var col = d.semestre-1
                                  return "translate("+ (50 + 200*col) + ",0)";
                              });*/
                                //.attr("x", 150);//function(d) {return (d.semestre-1)*15+1 + "%";});

      rectangulos.append("rect")
              //.attr("id", function(d){return d.nombre})
              .style("stroke", "gray")
              //Colores: Obligatoria: #e7eef8, Optativa: #ff9a66, Especializante: #9bfe65, Integrador: #9966ff
              .style("fill", function(d){ return defineColor(d.eje); })//"#e7eef8")
              //.attr("filter", "url(#dropshadow)")
              .attr("y", function(d) {return d.y;})//-30)
              .attr("x", function(d) {return (d.semestre-1)*15+5 + "%";})//-30)
              .attr("width", 160) //150
              .attr("height", 80)//70
              //Colores al pasar con el mouse:
              // Obligatoria: aliceblue
              // Optativa: #ffad82
              // Especializante: #adfd84
              // Integrador: #ad85fe
              .on("mouseover", function(d){
                var color;
                switch (d.eje) {
                case "P":
                  color = "#ffad82";
                  break;
                case "E":
                  color = "#adfd84";
                  break;
                case "I":
                  color = "#ad85fe";
                  break;
                default: color = "aliceblue";

              }
                d3.select(this).style("fill", color);})
              .on("mouseout", function(d){d3.select(this).style("fill", defineColor(d.eje)); })//function(){d3.select(this).style("fill", "#e7eef8");})
              .on("mousedown", function(d){ overlayInfo(d); });//openNav);//animateFirstStep);
/*
      rectangulos.append("line")
                .style("stroke", "black")
                .attr("x1", function(){return d3.select(this.parentNode).select("rect").attr("x");})//function(d) {return 15;})
                .attr("transform", "translate(15,0)")
                .attr("y1", function(d) {return d.y + 25;})
                .attr("x2", function(){console.log("BBox: " + d3.select(this.parentNode).select("rect").node().getBBox().x);
                  return d3.select(this.parentNode).select("rect").node().getBBox().x;})
                //.attr("x2", function(d) {return 135;})
                .attr("y2", function(d) {return d.y + 25 ;});
*/
      rectangulos.append("text")
              .attr("text-anchor", "middle")
              .attr("x", function(){return d3.select(this.parentNode).select("rect").attr("x");})//function(d){ return d3.select("rect[id='" + d.nombre + "']").attr("x");})//function(d) {return 75;})
              .attr("transform","translate(75,0)")
              .attr("y", function(d) {return d.y + 35;})
              .attr("dy", ".35em")
              //.text("Pineda guarro");
              .text(function(d) {return d.nombre;});

      //var wrap = d3.textwrap().bounds({height: 50, width: 50});
      //rectangulos.selectAll("text").call(wrap);


      rectangulos.append("text")
              .attr("x", function(){return d3.select(this.parentNode).select("rect").attr("x");})//75)
              .attr("transform", "translate(75,0)")
              .attr("y", function(d) {return d.y + 15;})
              .attr("text-anchor", "middle")
              .attr("dy", ".35em")
              .text(function(d) {return "Creditos: " + d.creditos});

      rectangulos.append("text")
              .attr("text-anchor", "middle")
              .attr("x", function(){return d3.select(this.parentNode).select("rect").attr("x");})//function(d) {return 75;})
              .attr("transform", "translate(75,0)")
              .attr("y", function(d) {return d.y + 55;})
              .attr("dy", ".35em")
              .text(function(d){ return d.semestre;});
              //.text("Pineda guarro");
              //.text(function(d) {return "Abre: " + datos.materias[d.mat_abre[0]].nombre;});

      function animateFirstStep(){
          d3.select(this)
            .transition()
              .delay(0)
              .duration(500)
              .attr("width", 145)
              .attr("height", 65)
              .each("end", animateSecondStep);
      };

      function animateSecondStep(){
          d3.select(this)
            .transition()
              .duration(500)
              .attr("width", 160)
              .attr("height", 80);
      };

      /* Open when someone clicks on the span element */
      function openNav() {
        document.getElementById("myNav").style.width = "100%";
      }

      /* Close when someone clicks on the "x" symbol inside the overlay */
      function closeNav() {
          document.getElementById("myNav").style.width = "0%";
      }

      function overlayInfo(datosMateria){
        var overlayHTML =  "<!-- Button to close the overlay navigation -->\
           <a href=\"javascript:void(0)\" class=\"closebtn\" onclick=\"closeNav()\">&times;</a>\
           <!-- Overlay content -->\
           <div class=\"overlay-content\">\
             <a><b>Materia:</b><br>"+ datosMateria["nombre"] +
             "</a>\
             <a><b>Creditos:</b><br>"+ datosMateria["creditos"] +
             "</a>\
             <a>"+ datos["materias"][datosMateria["mat_abre"]]["nombre"] +
             "</a>\
           </div>";
        //</div>";

        document.getElementById("myNav").innerHTML = (overlayHTML);
        openNav();
        //overlayHTML.getElementById("myNav").style.width="100%";
      }

      function defineColor(tipoMateria){switch (tipoMateria) {
        case "P":
          return "#ff9a66";
          break;
        case "E":
          return "#9bfe65";
          break;
        case "I":
          return "#9966ff";
          break;
        default:  return "#e7eef8";
      }}

      </script>


      </div>
      <div id="myNav" class="overlay"></div>
  </body>

</html>
